---1.What is the total amount each customer spent at the restaurant?---

select c.customer_id as customer , 
      sum(m.price)as Total_amount 
      from sales c join menu m 
      on c.product_id=m.product_id 
group by c.customer_id order by c.customer_id asc

--2.How many days has each customer visited the restaurant?---

select customer_id, 
        count(distinct order_date) as Days from sales group by customer_id
order by customer_id asc

--3.What was the first item from the menu purchased by each customer?--

with cte as(select s.customer_id, 
                s.order_date, 
                m.product_name,
                row_number() over(partition by s.customer_id order by s.customer_id,s.order_date,m.product_name )rn 
                from sales s join menu m on s.product_id=m.product_id) 
select customer_id,order_date,product_name from cte where rn=1 

--4.What is the most purchased item on the menu and how many times was it purchased by all customers?---

select product_name,
       count from (select m.product_name,count(m.product_name) as count 
       from sales s join menu m 
       on s.product_id=m.product_id group by m.product_name ) x 
       where x.count=(select max(count) 
      from (select product_name,
                   count from (select m.product_name,
                                      count(m.product_name) as count from sales s 
                                            join menu m on s.product_id=m.product_id group by m.product_name ))y)

--5.Which item was the most popular for each customer?---

with cte as(select s.customer_id,
            m.product_name,
            count(m.product_name) as count, 
            dense_rank() over(partition by s.customer_id order by count(m.product_name) desc )dr 
            from sales s join menu m on s.product_id=m.product_id group by m.product_name,s.customer_id )
select customer_id,product_name,count from cte where dr=1

---6.Which item was purchased first by the customer after they became a member?---
with cte as (select s.customer_id,s.product_id,s.order_date,m.join_date, row_number() 
over(partition by s.customer_id order by s.order_date )rn from sales s join members m on 
s.customer_id=m.customer_id where s.order_date>m.join_date)
select c.customer_id,c.order_date,m.product_name,c.join_date from cte c join menu m on 
c.product_id=m.product_id where rn=1 order by customer_id

--7. Which item was purchased just before the customer became a member?--

with cte as (select s.customer_id,
                    s.product_id,
                    s.order_date,
                    m.join_date, 
                    row_number() over(partition by s.customer_id order by s.order_date desc)rn 
from sales s join members m on s.customer_id=m.customer_id where s.order_date<m.join_date)
select c.customer_id,
       c.order_date,
       m.product_name,
       c.join_date 
from cte c join menu m on c.product_id=m.product_id where rn=1 order by customer_id

---8. What is the total items and amount spent for each member before they became a member?---

select s.customer_id,
       count(m2.product_name) as count ,
       sum(m2.price) as Total_amount 
 from sales s join members m1 on s.customer_id=m1.customer_id 
 join menu m2 on s.product_id=m2.product_id 
where s.order_date<m1.join_date  group by s.customer_id

---9.If each $1 spent equates to 10 points and sushi has a 2x points multiplier - 
--how many points would each customer have?

select s.customer_id,
sum(case when m2.product_name='sushi' then m2.price*20
     else m2.price*10 end ) as Points 
   from sales s join menu m2 on 
	 s.product_id=m2.product_id group by s.customer_id order by s.customer_id
